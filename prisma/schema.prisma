// Prisma schema for Garage ERP/CRM (Vehicles, Quotes, Repair Orders, Invoices, Stock)
// Provider: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTHENTICATION ============

enum UserRole {
  ADMIN
  USER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(USER)
  
  // Group membership for collaborative invoice management
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Invoices created by this user
  invoicesCreated Invoice[] @relation("InvoiceCreator")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([groupId])
}

// ============ GROUPS FOR COLLABORATIVE WORK ============

model Group {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  
  // Members of this group
  members     User[]
  
  // Invoices accessible by this group
  invoices    Invoice[] @relation("GroupInvoices")
  
  // Customers accessible by this group
  customers   Customer[] @relation("GroupCustomers")
  
  // Vehicles accessible by this group
  vehicles    Vehicle[] @relation("GroupVehicles")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([name])
}

// ============ BUSINESS MODELS ============

enum DocumentStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CONVERTED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELED
}

enum RepairOrderStatus {
  WAITING
  IN_PROGRESS
  DONE
  CANCELED
}

enum LineItemKind {
  PART
  LABOR
}

enum CustomerKind {
  PERSON
  BUSINESS
}

model Customer {
  id           String       @id @default(cuid())
  kind         CustomerKind @default(PERSON)
  firstName    String?
  lastName     String?
  companyName  String?
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  postalCode   String?
  city         String?
  country      String?      @default("FR")
  
  // Professional details
  siret        String?
  vatNumber    String?
  
  // Group ownership for collaborative access
  groupId      String?
  group        Group?       @relation("GroupCustomers", fields: [groupId], references: [id], onDelete: SetNull)

  vehicles     Vehicle[]
  quotes       Quote[]
  invoices     Invoice[]
  repairOrders RepairOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([phone])
  @@index([groupId])
}

model Vehicle {
  id                String  @id @default(cuid())
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  registrationPlate String  @unique
  vin               String? @unique
  make              String?
  model             String?
  year              Int?
  mileageKm         Int     @default(0)
  
  // Group ownership for collaborative access
  groupId           String?
  group             Group?  @relation("GroupVehicles", fields: [groupId], references: [id], onDelete: SetNull)

  quotes       Quote[]
  invoices     Invoice[]
  repairOrders RepairOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([make, model])
  @@index([groupId])
}

model Supplier {
  id           String @id @default(cuid())
  name         String
  email        String?
  phone        String?
  vatNumber    String?
  addressLine1 String?
  addressLine2 String?
  postalCode   String?
  city         String?
  country      String? @default("FR")

  parts Part[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Part {
  id             String   @id @default(cuid())
  supplierId     String?
  supplier       Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  name           String
  oemRef         String?
  supplierRef    String?
  barcode        String?

  purchasePriceHt Decimal @db.Decimal(10, 2)
  marginPercent   Decimal @db.Decimal(6, 2)
  salePriceHt     Decimal @db.Decimal(10, 2)
  vatRate         Decimal @db.Decimal(4, 2) @default(20.00)

  stockQty           Int @default(0)
  lowStockThreshold  Int @default(1)

  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([oemRef])
  @@index([supplierRef])
}

model Quote {
  id          String         @id @default(cuid())
  quoteNumber String         @unique
  status      DocumentStatus @default(DRAFT)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  issuedAt  DateTime?
  expiresAt DateTime?
  notes     String?

  subtotalHt Decimal @db.Decimal(12, 2) @default(0.00)
  vatTotal   Decimal @db.Decimal(12, 2) @default(0.00)
  totalTtc   Decimal @db.Decimal(12, 2) @default(0.00)
  currency   String  @default("EUR")

  items      QuoteItem[]

  repairOrder RepairOrder?
  invoice     Invoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([vehicleId])
  @@index([status])
}

model QuoteItem {
  id          String       @id @default(cuid())
  quoteId     String
  quote       Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  kind        LineItemKind @default(LABOR)
  partId      String?
  part        Part?        @relation(fields: [partId], references: [id], onDelete: SetNull)

  description String
  quantity    Decimal      @db.Decimal(10, 2) @default(1.00)
  unitPriceHt Decimal      @db.Decimal(10, 2) @default(0.00)
  vatRate     Decimal      @db.Decimal(4, 2)  @default(20.00)

  lineTotalHt  Decimal @db.Decimal(12, 2) @default(0.00)
  lineTotalTtc Decimal @db.Decimal(12, 2) @default(0.00)

  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quoteId])
  @@index([partId])
}

model RepairOrder {
  id       String            @id @default(cuid())
  roNumber String            @unique
  status   RepairOrderStatus @default(WAITING)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Restrict)

  mechanicId String?
  mechanic   Mechanic? @relation(fields: [mechanicId], references: [id], onDelete: SetNull)

  quoteId String? @unique
  quote   Quote?  @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  invoiceId String? @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  startedAt  DateTime?
  finishedAt DateTime?
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([vehicleId])
  @@index([mechanicId])
  @@index([status])
}

model Mechanic {
  id     String  @id @default(cuid())
  name   String
  email  String?
  active Boolean @default(true)

  repairOrders RepairOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  status        InvoiceStatus @default(DRAFT)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  quoteId String? @unique
  quote   Quote?  @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  repairOrder RepairOrder?
  
  // User who created this invoice
  createdById String?
  createdBy   User?   @relation("InvoiceCreator", fields: [createdById], references: [id], onDelete: SetNull)
  
  // Group that can access/modify this invoice
  groupId     String?
  group       Group?  @relation("GroupInvoices", fields: [groupId], references: [id], onDelete: SetNull)

  issuedAt DateTime?
  dueAt    DateTime?
  paidAt   DateTime?
  notes    String?

  subtotalHt Decimal @db.Decimal(12, 2) @default(0.00)
  vatTotal   Decimal @db.Decimal(12, 2) @default(0.00)
  totalTtc   Decimal @db.Decimal(12, 2) @default(0.00)
  currency   String  @default("EUR")

  items InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([vehicleId])
  @@index([status])
  @@index([createdById])
  @@index([groupId])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  kind   LineItemKind @default(LABOR)
  partId String?
  part   Part?        @relation(fields: [partId], references: [id], onDelete: SetNull)

  description String
  quantity    Decimal @db.Decimal(10, 2) @default(1.00)
  unitPriceHt Decimal @db.Decimal(10, 2) @default(0.00)
  vatRate     Decimal @db.Decimal(4, 2)  @default(20.00)

  lineTotalHt  Decimal @db.Decimal(12, 2) @default(0.00)
  lineTotalTtc Decimal @db.Decimal(12, 2) @default(0.00)

  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([partId])
}

model CompanySettings {
  id              String   @id @default(cuid())
  name            String
  legalStatus     String?  @default("SAS")
  capital         String?  @default("1000 â‚¬")
  siret           String?
  vatNumber       String?
  addressLine1    String?
  addressLine2    String?
  postalCode      String?
  city            String?
  country         String?  @default("FR")
  email           String?
  phone           String?
  website         String?
  logoUrl         String?
  invoiceFooter   String?

  updatedAt       DateTime @updatedAt
}
